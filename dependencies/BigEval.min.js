
/*
	BigEval.js
	by Avi Aryan (http://aviaryan.in)
	https://github.com/aviaryan/bigEval.js
*/
var BigEval=function(){this.err=0,this.errMsg="",this.errBR="IMPROPER_BRACKETS",this.errMS="MISSING_OPERATOR_AT_",this.errMN="MISSING_OPERAND_AT_",this.errIC="INVALID_CHAR_AT_",this.errFN="INVALID_FUNCTION_",this.errVD="UNDEFINED_VARIABLE_",this.errFL="FUNCTION_LIMIT_EXCEEDED_BY_",this.order=["!","@","\\/*%","+-","&","^","|"];var a=this.CONSTANT={};a.PI=Math.PI,a.PI_2=a.PI/2,a.LOG2E=Math.LOG2E,a.DEG=a.PI/180,a.E=Math.E,a.INFINITY="Infinity",a.NaN="NaN"};BigEval.prototype.exec=function(s){if(this.err=0,this.errMsg="",this.validate(s),this.err)return this.errMsg;s=s.replace(/\*\*/g,"@");var misOperator=/[a-z0-9][ \t]+[a-z0-9\.]/gi;if(misOperator.exec(s))return this.err=1,this.errMsg=this.errMS+misOperator.lastIndex;var misOperands=/[\+\-\\\/\*\@\%\&\^\|][ \t]*([\\\/\*\@\!\%\&\^\|\)]|$)/g;return misOperands.exec(s)?(this.err=1,this.errMsg=this.errMN+misOperands.lastIndex):(s=this.plusMinus(s.replace(/[ \t]/g,"")),s=this.solve(s),"+"===s.charAt(0)&&(s=s.slice(1)),s)},BigEval.prototype.solve=function(s){var fc=s.charAt(0);if(!fc.match(/[a-z0-9\.\+\-\(]/i))return this.err=1,this.errMsg=this.errIC;s=this.addPlusSign(s);for(var cb,fname,freturn,i,ob=s.indexOf("(");-1!==ob;){var obct=1;for(i=ob+1;s.length>i;i++)if("("==s[i])obct++;else if(")"===s[i]&&(obct--,0===obct)){cb=i;break}if(s.charAt(ob-1).match(/[a-z0-9_]/i)?(fname=s.slice(0,ob).match(/[a-z0-9_]+$/i),freturn=this.solve(s.slice(ob+1,cb)),freturn=this.solveFunc(freturn,fname[0])+"",s=s.slice(0,ob-fname[0].length)+freturn+s.slice(cb+1)):s=s.slice(0,ob)+this.solve(s.slice(ob+1,cb))+s.slice(cb+1),this.err)return this.errMsg;ob=s.indexOf("(")}if(-1!==s.indexOf(","))return this.addPlusSign(s);var p,bp,ap,seg,c,cs,b,a,isAddOn=0;for(i=0;this.order.length>i;i++)for(cs=this.order[i],"+-"==cs&&(s=this.plusMinus(s),isAddOn=1),p=this.leastIndexOf(s,cs,1);p>0;)if(bp=s.slice(0,p).match(/[\-\+]*(\de\-|\de\+|[a-z0-9_\.])+$/i),ap=s.slice(p+1).match(/[\-\+]*(\de\-|\de\+|[a-z0-9_\.])+/i),null==ap&&(ap=[""]),null!=bp)if(isAddOn||bp[0].match(/[\-\+]/)&&(bp[0]=bp[0].slice(1)),isAddOn&&"e"==bp[0].charAt(bp[0].length-1)&&bp[0].charAt(bp[0].length-2).match(/\d/))p=this.leastIndexOf(s,cs,p+1);else{if(c=s.charAt(p),b=this.parseVar(this.plusMinus(bp[0])),a=this.parseVar(this.plusMinus(ap[0])),this.err)return this.errMsg;"!"==c?(("+"==bp[0].charAt(0)||"-"==bp[0].charAt(0))&&(bp[0]=bp[0].slice(1)),b=this.parseVar(bp[0]),seg=this.fac(b)+"",ap=[""]):("/"==c||"\\"==c?seg=this.div(b,a):"*"==c?seg=this.mul(b,a):"+"==c?seg=this.add(b,a):"-"==c?seg=this.sub(b,a):"@"==c?seg=this.pow(b,a):"%"==c?seg=this.mod(b,a):"&"==c?seg=this.and(b,a):"^"==c?seg=this.xor(b,a):"|"==c&&(seg=this.or(b,a)),seg=this.addPlusSign(seg+"")),s=s.slice(0,p-bp[0].length)+seg+s.slice(p+ap[0].length+1),p=this.leastIndexOf(s,cs,1)}else p=this.leastIndexOf(s,cs,p+1);return s=this.addPlusSign(s),this.parseVar(s)},BigEval.prototype.validate=function(s){for(var stack=[],i=0;s.length>i;i++)if("("==s[i])stack.push(0);else if(")"==s[i]){if(!(stack.length>0)){this.makeError(this.errBR);break}stack.pop()}0==this.err&&0!=stack.length&&this.makeError(this.errBR)},BigEval.prototype.solveFunc=function(s,fname){var f,arr=s.split(","),isMath=0,isBigEval=0;if("function"==typeof this[fname])isBigEval=1;else if("function"==typeof Math[fname])f=Math[fname],isMath=1;else{if("function"!=typeof window[fname])return this.makeError(this.errFN+fname),0;f=window[fname]}for(var i=0;arr.length>i;i++)arr[i]=isMath?Number(this.solve(arr[i])):this.solve(arr[i]);return 1==arr.length?isBigEval?this[fname].call(this,arr[0]):f(arr[0]):2==arr.length?isBigEval?this[fname].call(this,arr[0],arr[1]):f(arr[0],arr[1]):3==arr.length?isBigEval?this[fname].call(this,arr[0],arr[1],arr[2]):f(arr[0],arr[1],arr[2]):4==arr.length?isBigEval?this[fname].call(this,arr[0],arr[1],arr[2],arr[3]):f(arr[0],arr[1],arr[2],arr[3]):this.makeError(this.errFL+fname)},BigEval.prototype.parseVar=function(s){var z;if(z=s.match(/^[\+\-]?[a-z][a-z0-9_]*$/i)){var zs="";return("-"==z[0].charAt(0)||"+"==z[0].charAt(0))&&(zs=z[0].slice(0,1),z[0]=z[0].slice(1)),this.CONSTANT[z[0].toUpperCase()]!==void 0?zs+this.CONSTANT[z[0].toUpperCase()]:this.CONSTANT[z[0]]!==void 0?zs+this.CONSTANT[z[0]]:this.makeError(this.errVD+z[0])}return s},BigEval.prototype.leastIndexOf=function(s,cs,sp){for(var p,l=-1,i=0;cs.length>i;i++)p=s.indexOf(cs[i],sp),-1!=p&&(-1==l?l=p:l>p&&(l=p));return l},BigEval.prototype.plusMinus=function(s){return s.replace(/\+\+/g,"+").replace(/\+\-/g,"-").replace(/\-\+/g,"-").replace(/\-\-/g,"+")},BigEval.prototype.addPlusSign=function(s){return"-"!=s.charAt(0)&&"+"!=s.charAt(0)&&(s="+"+s),s},BigEval.prototype.makeError=function(msg){return this.err=1,this.errMsg=msg},BigEval.prototype.add=function(a,b){return Number(a)+Number(b)},BigEval.prototype.sub=function(a,b){return Number(a)-Number(b)},BigEval.prototype.mul=function(a,b){return Number(a)*Number(b)},BigEval.prototype.div=function(a,b){return Number(a)/Number(b)},BigEval.prototype.pow=function(a,b){return Math.pow(Number(a),Number(b))},BigEval.prototype.fac=function(n){var s="1";n=Number(n);for(var i=2;n>=i;i++)s=this.mul(s,i);return s},BigEval.prototype.mod=function(a,b){return Number(a)%Number(b)},BigEval.prototype.and=function(a,b){return Number(a)&Number(b)},BigEval.prototype.xor=function(a,b){return Number(a)^Number(b)},BigEval.prototype.or=function(a,b){return Number(a)|Number(b)},"undefined"!=typeof module&&module.exports&&"undefined"!=typeof exports&&(module.exports=BigEval);
